#!/bin/bash
#datacheck
if [ "$#" != 1 ]; then
    echo "usage: ./run 2016-xx-xx &"
    echo "这个时间代表获取获取它两周前的数据"
    exit 2
fi
#确认脚本路径
dir=`pwd`
if [[ "$dir" =~ "TY" ]]
then
	echo "path : $dir"
else
	dir="${dir}/TY"
	echo "path : $dir"
fi
#准备基础数据
	# date=$1
	# echo "=====waiting for data ready====="
	# sh ${dir}/data.sh $date && echo "======data ready!====="
	# echo "===== start res handle ====="
	# nohup sh ${dir}/reshandle.sh && echo "=====waiting for rpm handle====="
	# time sh ${dir}/rpmhandle.sh
	# echo "===== work done ====="
	# echo "please check your report: Report"

##处理邮件数据
	sed "s/\t/|/g;s/424892/api3g2/g;s/424891/api3g/g;s/41699/mlvmama/g" Report > new_report
	#以响应时间排序的所有接口数据
	sort -rn -t '|' -k 8 new_report > Allist
	#新版本2秒以上访问量大于1000的数据
	nowversion=`awk -F '|' '{print $5}' new_report| grep [0-9] |sort -u |tail -n1`
	grep "|${nowversion}|" new_report | sort -rn -t '|' -k 9 |awk -F '|' '{if($8 > 2 && $9 > 1000 ){print}}' > TopNew
	#前一个版本2秒以上访问量大于1000的数据
	prevversion=`awk -F '|' '{print $5}' new_report| grep [0-9] |sort -u |tail -n2 | head -n1`
	echo "now:${nowversion}  prev:${prevversion} "
	grep "|${prevversion}|" new_report | sort -rn -t '|' -k 9 |awk -F '|' '{if($8 > 2 && $9 > 1000 ){print}}' > TopPrev
	#新版本不重复接口所有数据
	grep "|${nowversion}|" new_report | sort -rn -t '|' -k 8 | awk -F'|' '!a[$3_$4]++' > StandNew
	#老版本不重复接口所有数据
	grep "|${prevversion}|" new_report | sort -rn -t '|' -k 8 | awk -F'|' '!a[$3_$4]++' > StandPrev
	#计算各接口占比
	DataTotal=`grep 'api3g2|' new_report |awk 'END{print NR}'`
	Total=`awk 'END{print NR}' StandNew`
	ms=`grep 'api3g2|'  new_report |awk -F'|' '{if($8 < 1){print}}' |awk 'END{print NR}'`
	one=`grep 'api3g2|'  new_report |awk -F'|' '{if($8 >= 1 && $8 < 2 ){print}}'  |awk 'END{print NR}'`
	two=`grep 'api3g2|'  new_report |awk -F'|' '{if($8 >= 2 && $8 < 3){print}}'  |awk 'END{print NR}'`
	three=`grep 'api3g2|'  new_report |awk -F'|' '{if($8 >= 3 && $8 < 4){print}}'  |awk 'END{print NR}'`
	four=`grep 'api3g2|'  new_report |awk -F'|' '{if($8 >= 4 && $8 < 5){print}}'  |awk 'END{print NR}'`
	five=`grep 'api3g2|'  new_report |awk -F'|' '{if($8 >= 5){print}}'  |awk 'END{print NR}'`

	zs=`awk 'BEGIN{printf "%.f%%\n",('$ms'/'$DataTotal')*100}'`
	os=`awk 'BEGIN{printf "%.f%%\n",('${one}'/'${DataTotal}')*100}'`
	ts=`awk 'BEGIN{printf "%.f%%\n",('${two}'/'${DataTotal}')*100}'`
	tts=`awk 'BEGIN{printf "%.f%%\n",('${three}'/'${DataTotal}')*100}'`
	fs=`awk 'BEGIN{printf "%.f%%\n",('${four}'/'${DataTotal}')*100}'`
	ffs=`awk 'BEGIN{printf "%.f%%\n",('${five}'/'${DataTotal}')*100}'`

	echo "接口数据（接口数）：${DataTotal} (${Total})"
	echo "毫秒级：${zs}"
	echo "1~2秒：${os}"
	echo "2~3秒：${ts}"
	echo "3~4秒：${tts}"
	echo "4~5秒：${fs}"
	echo "5秒以上：${ffs}"

#构造HTML
#构造头和css
>TYreport.html
(
cat << EOF
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>LVMAMA 听云半月刊</title>
EOF
)>> TYreport.html
cat cssfile >> TYreport.html
(
cat << EOF
</head><body>
<div class="container" style="padding-top:80px">
<div class="row">
<div class="panel panel-primary">
<!-- Default panel contents -->
<div class="panel-heading">接口简报</div>
<div class="panel-body">
<p>接口数据（接口数）：${DataTotal} (${Total})</p></div>
<table class="table table-hover table-condensed table-responsive"><thead><tr><th>时间</th><th>毫秒级</th><th>1~2秒</th><th>2~3秒</th><th>3~4秒</th><th>4~5秒</th><th>5秒以上</th></tr></thead><tbody><tr><th>${date}</th><td>${zs}</td><td>${os}</td><td>${ts}</td><td>${tts}</td><td>${fs}</td><td>${ffs}</td></tr></tbody></table></div></div><hr>
<div class="row">
<div class="col-md-6"><div class="panel panel-primary"><div class="panel-heading">APP版本：${nowversion}</div><div class="panel-body"><p>响应耗时超过3秒，且日访问量超过1000的接口，建议优先优化</p></div>
<table class="table table-hover table-condensed table-responsive">
<thead><tr><th>序号</th><th>HOST</th><th>描述</th><th>method</th><th>version</th><th>lvversion</th><th>是否HTTPS</th><th>是否POST</th><th>响应时间/秒</th><th>日访问量</th></tr></thead><tbody>
EOF
)>> TYreport.html
#构造需要修复的新版本
p=0
cat TopNew | while read line
do
p=`expr ${p} + 1`
echo $line | awk  -F '|' '{print "<tr><th>'$p'</th><td>"$1"</td><td>"$2"</td><td>"$3"</td><td>"$4"</td><td>"$5"</td><td>"$6"</td><td>"$7"</td><td>"$8"</td><td>"$9"</td></tr>"}' >> TYreport.html
done
(
cat << EOF				
</tbody></table></div></div><div class="col-md-6"><div class="panel panel-primary">
<div class="panel-heading">APP版本：${prevversion}</div>
<div class="panel-body"><p>响应耗时超过3秒，且日访问量超过1000的接口，建议优先优化</p></div>
<table class="table table-hover table-condensed table-responsive"><thead><tr><th>序号</th><th>HOST</th><th>描述</th><th>method</th><th>version</th><th>lvversion</th><th>是否HTTPS</th><th>是否POST</th><th>响应时间/秒</th><th>日访问量</th></tr></thead><tbody>
EOF
)>> TYreport.html
#构造需要修复的前一个版本
p=0
cat TopPrev | while read line
do
p=`expr ${p} + 1`
echo $line | awk -F '|' '{print "<tr><th>'$p'</th><td>"$1"</td><td>"$2"</td><td>"$3"</td><td>"$4"</td><td>"$5"</td><td>"$6"</td><td>"$7"</td><td>"$8"</td><td>"$9"</td></tr>"}' >> TYreport.html
done
(cat << EOF				
</tbody></table></div></div></div>
EOF
)>> TYreport.html
#构造新版本所有数据
(cat << EOF
<div class="row">
<div class="col-md-6">
<div class="panel panel-primary">
<!-- Default panel contents -->
<div class="panel-heading"> ${nowversion}版本接口响应排行</div>
<div class="panel-body"><p></p></div>
<table class="table table-hover table-condensed table-responsive">
<thead><tr><th>序号</th><th>HOST</th><th>描述</th><th>method</th><th>version</th><th>lvversion</th><th>是否HTTPS</th><th>是否POST</th><th>响应时间/秒</th><th>日访问量</th></tr>
</thead><tbody>
EOF
)>> TYreport.html
p=0
cat StandNew | while read line
do
p=`expr ${p} + 1`
echo $line | awk  -F '|' '{print "<tr><th>'$p'</th><td>"$1"</td><td>"$2"</td><td>"$3"</td><td>"$4"</td><td>"$5"</td><td>"$6"</td><td>"$7"</td><td>"$8"</td><td>"$9"</td></tr>"}' >> TYreport.html
done
(cat << EOF				
</tbody></table></div></div>
EOF
)>> TYreport.html
#构造前一个版本所有数据
(cat << EOF
<div class="col-md-6">
<div class="panel panel-primary">
<!-- Default panel contents -->
<div class="panel-heading"> ${prevversion}版本接口响应排行</div>
<div class="panel-body"><p></p></div>
<table class="table table-hover table-condensed table-responsive">
<thead><tr><th>序号</th><th>HOST</th><th>描述</th><th>method</th><th>version</th><th>lvversion</th><th>是否HTTPS</th><th>是否POST</th><th>响应时间/秒</th><th>日访问量</th></tr>
</thead><tbody>
EOF
)>> TYreport.html
p=0
cat StandPrev | while read line
do
p=`expr ${p} + 1`
echo $line | awk -F '|'  '{print "<tr><th>'$p'</th><td>"$1"</td><td>"$2"</td><td>"$3"</td><td>"$4"</td><td>"$5"</td><td>"$6"</td><td>"$7"</td><td>"$8"</td><td>"$9"</td></tr>"}' >> TYreport.html
done
(cat << EOF				
</tbody></table></div></div></div>
EOF
)>> TYreport.html
#构造所有数据
(cat << EOF
<div class="row">
<div class="panel panel-primary">
<!-- Default panel contents -->
<div class="panel-heading"> 本期所有接口数据 </div>
<div class="panel-body"><p></p></div>
<table class="table table-hover table-condensed table-responsive">
<thead><tr><th>序号</th><th>HOST</th><th>描述</th><th>method</th><th>version</th><th>lvversion</th><th>是否HTTPS</th><th>是否POST</th><th>响应时间/秒</th><th>日访问量</th></tr>
</thead><tbody>
EOF
)>> TYreport.html
p=0
cat Allist | while read line
do
p=`expr ${p} + 1`
echo $line | awk  -F '|' '{print "<tr><th>'$p'</th><td>"$1"</td><td>"$2"</td><td>"$3"</td><td>"$4"</td><td>"$5"</td><td>"$6"</td><td>"$7"</td><td>"$8"</td><td>"$9"</td></tr>"}' >> TYreport.html
done
(cat << EOF				
</tbody></table></div></div></div></body></html>
EOF
)>> TYreport.html
	
#最后发邮件

exit 0
