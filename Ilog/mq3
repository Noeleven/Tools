#!/bin/bash
#1. curl the url & save it to a file（以接口命名）.
#2. anaylse to get debugMsg
#3. 执行多次的结果保存到一个文件
#4. count avg min max && print
#5. 
#usage

if [ "$#" != 2 ]; then
	echo "usage: nohup ILog.sh 执行次数 执行间隔时间秒 &"
	echo "具体的接口URL需要在脚本中配" 
	exit 2
fi

CYCLE=$1
SLEEPTIME=$2

	NAME="m_befor_order_1"
	#name file
	NAMETIME=`date +%Y-%m-%d`
	SFILE="logs/src_$NAME"
	LFILE="logs/log_$NAME"
	TFILE="logs/tmp_$NAME"
	RFILE="logs/end_${NAME}_${NAMETIME}"
	for i in `seq ${CYCLE}`
	do
	#获取到接口的完整数据日志
		now=`date +%Y-%m-%d_%H:%M:%S`
		curl 'http://m.lvmama.com/api/router/rest.do?method=api.com.ticket.order.inputTicketOrder&version=2.0.0&lvversion=7.6.1&IS_DEBUG=1&productId=622407&goodsIds=2777050&lvkey=37cc1b191999a8f49c82255b33ac9e80' -H 'Pragma: no-cache' -H 'Accept-Encoding: gzip, deflate, sdch' -H 'Accept-Language: zh-CN,zh;q=0.8' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.106 Safari/537.36' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8' -H 'Cache-Control: no-cache' -H 'Cookie: CoreID6=18247111830914682331978&ci=90409730; uid=wKgKb1eDdg0a/FAsNPfrAg==; mb_udid=3e2eb1c4-670b-495c-a527-28b4f227a1bc; new_order_count=909; lastClickCouponMills=1468233807598; lastWalletKey=CF18475CA8ECB3AC8BE0E74ED0949808; Hm_lvt_9e5ece794554043c941bd75e1b8a57c9=1468233810; mb_u=yuzhibing8; mb_p=""; _lvTrack_u_ud=7DCF71CD-C288-4090-8C59-108CB1B9B674; cookieNumber=499; tele=4006-040-499; cm_mmc=CPS-_-lingke-_-a-_-a; utm_source=LINKTECH; utm_medium=CPS; losc=045050; source=LINKTECH; serviceId="http://www.lvmama.com"; ltInfo=A100200613; cpsId=f23bbc602a5ab47c8147a3ae1845002e; orderFromChannel=LINKTECH; oUC=015766045050; oUT=06130614; fingerprint=00a3550f50276422124e96b63422c7a9; __xsptplus443=443.2.1468460486.1468460590.3%231%7Cbaidu10%7Csem%7Ccpc%7C%25E9%25A9%25B4%25E5%25A6%2588%25E5%25A6%2588%7C%23%2330DYqEbUDrOpDvmZ1ITYGjC-xMs4EPIy%23; _lvTrack_u_sd=4B9209C3-E419-4186-A86E-1A6B7734D5C3; _lvTrack_firstVisitTime=1468817513624; _lvTrack_preVisitTime=1468817513625; _pzfxuvpc=1468412945901%7C1414897582695916025%7C11%7C1468817514134%7C3%7C7503403873723438829%7C1373720779442891994; cityName=%u4E0A%u6D77; ticketCityName=%u4E0A%u6D77; cityStation=SH; cityTicketId=1; cityTicketPinyin=shanghai; wx_4_logout=false; lvtu_mb_mobile=13621998464; oIC=080561101763101763102414; oIT=0614061906190619; lvsessionid=79fd56d6-ab33-47be-9a90-29420ea6cc0d; cmTPSet=Y; PHPSESSID=490r5p5hpbmmv0kfei3154pb23; __utma=30114658.1519742379.1468233198.1468906863.1468912909.17; __utmb=30114658.13.10.1468912909; __utmc=30114658; __utmz=30114658.1468906863.16.4.utmcsr=mp.weixin.qq.com|utmccn=(referral)|utmcmd=referral|utmcct=/; Hm_lvt_cb09ebb4692b521604e77f4bf0a61013=1468913589; Hm_lpvt_cb09ebb4692b521604e77f4bf0a61013=1468913596; 90409730_clogin=l=1468912908&v=1&e=1468916288199' -H 'Connection: keep-alive' --compressed > $SFILE
		echo $now >> $LFILE
		sed 's/,/\n/g' $SFILE |grep debugMsg| awk -F '\"' '{ print $4 }' | sed 's/ms\\n/ms\n\\n/g' >> $LFILE
		sleep ${SLEEPTIME}
	done
	#根据输出次数和行数的关系，计算最终结果行数（计算次数）
	lines=`wc -l $LFILE | awk '{print $1}' `
	Flines=`expr $lines / $CYCLE`
	#根据行数，计算avg min max的函数
	cp $LFILE $RFILE
	echo "" >> $RFILE
	for o in `seq 2 $Flines`
		do
			lineinfo=`sed -n ${o}p $LFILE | grep -o '\[.*\]'`
			#passinfo=`sed -n ${o}p $LFILE | awk -F ":" '{print $2}'`
		#获取每次测试每个步骤的costtime
			tmpinfo=`echo $lineinfo | sed "s/\[//g;s/\]//g" `
			cat $LFILE | grep "${tmpinfo}" | awk -F "costTime:" '{print $2}'|awk '{ print int($0) }'  > $TFILE
		#计算
			passavgTime=`cat $TFILE | awk '{sum+=$1}END{print sum/NR}'`
			passMaxTime=`cat $TFILE | sort -n| tail -n 1`
			passminTime=`cat $TFILE | sort -n| head -n 1`
			passrangeTime="TimeRange: ${passminTime} ~ ${passMaxTime}"
			echo "${lineinfo} avgCostTime: ${passavgTime}ms ${passrangeTime}ms " >> $RFILE
	done
	rm -f $SFILE $LFILE $TFILE
	cat $RFILE | mutt -s "${NAME}_LOG" zhangqiang@lvmama.com

#发邮件方法
#echo "" | mutt -s "" -t someone

exit 0
